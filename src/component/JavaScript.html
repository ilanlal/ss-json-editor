<!-- JavaScript -->
<script>
    (function () {
        const PAGE_SIZE = 25;
        //resource = 
        const addon = this;
        // Global_Resources
        const Global_Resources = {
            "version": '0.0.1',
            "en": {
                "appTitle": "Json",
                "loading": "Loading...",
                "pleaseWait": "Please wait...",
                "welcome": "Welcome",
                "addonIsLive": "üü¢ The add-on is live",
                "bindSelectRange": "Bind selected range",
                "bindSelectRangeDesc": "Bind the selected range to the app",
                "refresh": "‚Üª Refresh",
                "rebind": "‚Üπ Bind new range",
                "minifyAll": "Minify All",
                "prittfyAll": "Prittfy All",
                "nextPage": "Next Page",
                "cancel": "‚äò Cancel",
                "close": "‚äù Close",
                "save": "Save",
                "saveAndClose": "Save & Close",
                "openInDialog": "‚á± Open",
                "highlight": "‚©Æ Highlight",
                "prittfy": "Prittfy",
                "minify": "Minify",
                "done": "Done",
                "notImplemented": "Not implemented",
                "error": "Error: ",
                "noValues": "No values in the selected range",
                "status": "Status",
                "report": "Report",
                "textEditor": "Text Editor",
                "textEditorPlaceholder": "Enter your text here...",
                "totalCells": "Total cells",
                "totalSuccess": "Total success",
                "totalFail": "Total fails",
                "a1nNotation": "A1 Notation range",
                "numColumns": "Number of columns",
                "numRows": "Number of rows",
                "pageSize": "Page size",
                "offset": "Offset",
                "nextOffset": "Next offset",
                "page": "Page",
                "jsonValid": "JSON is valid",
                "jsonInvalid": "JSON is invalid",
                "welcomeTips": "üí° The add-on will validate the JSON data in the selected range and display the results in a report.",
                "reportTips": "üí° The report shows the validation status of each cell in the selected range.",
                "textEditorTips": "The text editor allows you to edit the JSON data in a cell. You can highlight, minify, or prettify the JSON data. You can also save the changes back to the cell or open the cell in a dialog editor.",
                "dialogEditorTips": "The dialog editor allows you to edit the JSON data in a cell in a dialog box. You can highlight, minify, or prettify the JSON data. You can also save the changes back to the cell or close the dialog editor."
            },
            "fr": {
                "appTitle": "Json",
                "loading": "Chargement...",
                "pleaseWait": "Veuillez patienter...",
                "welcome": "Bienvenue",
                "addonIsLive": "üü¢ L'extension est en direct",
                "bindSelectRange": "Lier la plage s√©lectionn√©e",
                "bindSelectRangeDesc": "Lier la plage s√©lectionn√©e √† l'application",
                "refresh": "‚Üª Actualiser",
                "rebind": "‚Üπ Lier une nouvelle plage",
                "minifyAll": "Minifier tout",
                "prittfyAll": "Prittfy tout",
                "nextPage": "Page suivante",
                "cancel": "‚äò Annuler",
                "close": "‚äù Fermer",
                "save": "Enregistrer",
                "saveAndClose": "Enregistrer et fermer",
                "openInDialog": "‚á± Ouvrir",
                "highlight": "Surligner",
                "prittfy": "Prittfy",
                "minify": "Minifier",
                "done": "Termin√©",
                "notImplemented": "Non impl√©ment√©",
                "error": "Erreur: ",
                "noValues": "Pas de valeurs dans la plage s√©lectionn√©e",
                "status": "Statut",
                "report": "Rapport",
                "textEditor": "√âditeur de texte",
                "textEditorPlaceholder": "Entrez votre texte ici...",
                "totalCells": "Cellules totales",
                "totalSuccess": "Succ√®s total",
                "totalFail": "√âchecs totaux",
                "a1nNotation": "Plage de notation A1",
                "numColumns": "Nombre de colonnes",
                "numRows": "Nombre de lignes",
                "pageSize": "Taille de la page",
                "offset": "D√©calage",
                "nextOffset": "D√©calage suivant",
                "page": "Page",
                "jsonValid": "JSON est valide",
                "jsonInvalid": "JSON est invalide",
                "welcomeTips": "üí° L'extension validera les donn√©es JSON dans la plage s√©lectionn√©e et affichera les r√©sultats dans un rapport.",
                "reportTips": "üí° Le rapport montre l'√©tat de validation de chaque cellule de la plage s√©lectionn√©e.",
                "textEditorTips": "L'√©diteur de texte vous permet de modifier les donn√©es JSON dans une cellule. Vous pouvez surligner, minifier ou embellir les donn√©es JSON. Vous pouvez √©galement enregistrer les modifications dans la cellule ou ouvrir la cellule dans un √©diteur de dialogue.",
                "dialogEditorTips": "L'√©diteur de dialogue vous permet de modifier les donn√©es JSON dans une cellule dans une bo√Æte de dialogue. Vous pouvez surligner, minifier ou embellir les donn√©es JSON. Vous pouvez √©galement enregistrer les modifications dans la cellule ou fermer l'√©diteur de dialogue."
            }
        };
        const locale = 'en';
        const resources = Global_Resources[locale];

        // Sidebar
        const _sidebar = this.Sidebar = {
            // Model class
            AppHandler: {
                // start method
                start: (e) => {
                    console.log('üòÄ start', e);
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderSidebar({ container: document.getElementById("app") });
                    viewModel.renderWorkInProgress({
                        cardKey: viewModel.WELCOME_CARD_ID,
                        message: resources.bindSelectRangeDesc
                    });

                    // call the server
                    google.script.run
                        .withSuccessHandler(_sidebar.AppHandler.onServerSuccess)
                        .withFailureHandler(_sidebar.AppHandler.onServerFailure)
                        .fetchSelectedRange();
                },
                // onClick method
                onClick: (e) => {
                    console.log('üòÄ onClick', e);
                    const viewModel = _sidebar.ViewModel;
                    if (e.target.id === 'rebind') {
                        // hide the Text editor card
                        document.getElementById(viewModel.TEXT_CARD_ID).classList.add('hidden');
                        // clear the report table
                        document.getElementById("report").querySelector('tbody').innerHTML = '';
                        // hide the report card
                        document.getElementById(viewModel.REPORT_CARD_ID).classList.add('hidden');

                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.WELCOME_CARD_ID,
                            message: resources.bindSelectRange + ' ' + resources.pleaseWait
                        });
                        // call the server
                        google.script.run
                            .withSuccessHandler(_sidebar.AppHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.AppHandler.onServerFailure)
                            .fetchSelectedRange();
                    }
                },
                // onServerSuccess method
                onServerSuccess: (response) => {
                    console.log('üòÄ onServerSuccess', response);
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderIdleState({
                        cardKey: viewModel.WELCOME_CARD_ID,
                        message: resources.addonIsLive
                    });

                    // render the page with the response
                    viewModel.renderSelectedRange({
                        container: document.getElementById(viewModel.RANGE_ID),
                        range: response.range
                    });
                    _sidebar.ReportHandler.start({
                        container: document.getElementById(viewModel.REPORT_CARD_ID),
                        range: response.range
                    });
                },
                // onServerFailure method
                onServerFailure: (response) => {
                    console.log('üòÄ onServerFailure', response);
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: viewModel.WELCOME_CARD_ID,
                        message: `<span class="error">${response.message}</span>`
                    });
                    viewModel.renderLed({ led: 'üî¥' });
                    viewModel.enableAllButtons();

                }
            },
            // ReportHandler class
            ReportHandler: {
                start: ({ container, range }) => {
                    console.log('üòÄ ReportHandler.start', { container, range });
                    const viewModel = _sidebar.ViewModel;
                    // todo: render the card
                    viewModel.renderTabelReport({
                        container: document.getElementById("report"),
                        range: range
                    });

                    viewModel.renderWorkInProgress({
                        cardKey: viewModel.REPORT_CARD_ID,
                        message: resources.loading + ' ' + resources.page + ' 1' + ' ' + range.a1n
                    });
                    // show the response card
                    container.classList.remove('hidden');
                    // call the server
                    google.script.run
                        .withSuccessHandler(_sidebar.ReportHandler.onServerSuccess)
                        .withFailureHandler(_sidebar.ReportHandler.onServerFailure)
                        .doValidationReport({
                            pageSize: PAGE_SIZE,
                            offset: 0,
                            a1n: range.a1n
                        });
                },
                onClick: (e, offset, a1n) => {
                    console.log('üòÄ onClick', { e, offset, a1n });
                    const viewModel = _sidebar.ViewModel;

                    if (e.target.id === 'refresh') {
                        const currentA1n = document.getElementById(viewModel.RANGE_ID).innerText;

                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.REPORT_CARD_ID,
                            message: resources.refresh + ' ' + currentA1n
                        });

                        // close text editor card
                        document.getElementById(viewModel.TEXT_CARD_ID).classList.add('hidden');
                        // clear the report table rows
                        document.getElementById("report").querySelector('tbody').innerHTML = '';

                        google.script.run.focusRange(currentA1n);

                        // call the server
                        google.script.run
                            .withSuccessHandler(_sidebar.ReportHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.ReportHandler.onServerFailure)
                            .doValidationReport({
                                pageSize: PAGE_SIZE,
                                offset: 0,
                                a1n: currentA1n
                            });
                    }
                    else if (e.target.id === 'rebind') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.REPORT_CARD_ID,
                            message: resources.rebind
                        });
                        // close text editor card
                        document.getElementById(viewModel.TEXT_CARD_ID).classList.add('hidden');
                        // clear the report table rows
                        document.getElementById("report").querySelector('tbody').innerHTML = '';
                        // close the report card
                        document.getElementById(viewModel.REPORT_CARD_ID).classList.add('hidden');

                        _sidebar.AppHandler.start();
                    }
                    else if (e.target.id === 'nextPage' && offset) {
                        google.script.run
                            .withSuccessHandler(_sidebar.ReportHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.ReportHandler.onServerFailure)
                            .doValidationReport({
                                pageSize: PAGE_SIZE,
                                offset: offset,
                                a1n: a1n
                            });
                    }
                },
                onServerSuccess: (response) => {
                    console.log('üòÄ ReportHandler.onServerSuccess', response);
                    const viewModel = _sidebar.ViewModel;
                    // render the page with the response
                    viewModel.renderValidateResponse({
                        container: document.getElementById(viewModel.REPORT_CARD_ID),
                        response
                    });
                    if (response?.nextOffset) {
                        viewModel.renderSubtitle({
                            cardKey: viewModel.REPORT_CARD_ID,
                            message: resources.loading + ' ' + resources.page + ' ' + (response.nextOffset / PAGE_SIZE)
                        });
                        // fetch the next page
                        google.script.run
                            .withSuccessHandler(_sidebar.ReportHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.ReportHandler.onServerFailure)
                            .doValidationReport({
                                pageSize: PAGE_SIZE,
                                offset: response.nextOffset,
                                a1n: response.range.a1n
                            });
                    }
                    else {
                        viewModel.renderSubtitle({
                            cardKey: viewModel.REPORT_CARD_ID,
                            message: resources.done
                        });
                        viewModel.renderLed({ led: 'üîò' });
                        viewModel.enableAllButtons();
                    }
                },
                onServerFailure: (response) => {
                    console.log('üòÄ ReportHandler.onServerFailure', response);
                    const viewModel = _sidebar.ViewModel;
                    // render the page with the response
                    viewModel.renderValidateResponse({
                        container: document.getElementById(viewModel.REPORT_CARD_ID),
                        response
                    });
                    viewModel.renderSubtitle({
                        cardKey: viewModel.REPORT_CARD_ID,
                        message: `<span class="error">${response.message}</span>`
                    });

                    viewModel.renderLed({ led: 'üî¥' });
                    viewModel.enableAllButtons();
                }
            },
            // 
            TextEditorHandler: {
                // start method
                start: ({ container, cell }) => {
                    console.log('üòÄ TextEditorHandler.start', { container, cell });
                    // render the text editor using viewModel
                    const viewModel = _sidebar.ViewModel;
                    document.getElementById(viewModel.TEXT_CARD_ID).classList.remove('hidden');
                    google.script.run
                        .focusCell(cell.range);
                    viewModel.renderTextEditor({
                        container: container,
                        a1nRange: cell.range,
                        input: cell.input,
                        message: cell.message
                    });
                    _sidebar.TextEditorHandler.onKeyUp({
                        target: container.querySelector(`#${_sidebar.ViewModel.TEXT_AREA_ID}`)
                    });
                },
                // onKeyUp method
                onKeyUp: (e) => {
                    // validate the input
                    const text = e.target.value;
                    let isValid = true;
                    const viewModel = _sidebar.ViewModel;
                    try {
                        JSON.parse(text);
                        // clear the error message

                        viewModel.renderSubtitle({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: `<span class="success">‚úì ${resources.jsonValid}</span>`,
                        });

                        // enable mini & pritty buttons
                        document.getElementById('prittfy').disabled = false;
                        document.getElementById('prittfy').classList.remove('disabled');
                        document.getElementById('minify').disabled = false;
                        document.getElementById('minify').classList.remove('disabled');
                    } catch (error) {
                        isValid = false;
                        // show the error message
                        viewModel.renderSubtitle({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: `<span class="error">‚®Ç ${error.message}</span>`
                        });

                        // disabled mini & pritty buttons
                        document.getElementById('prittfy').disabled = true;
                        document.getElementById('prittfy').classList.add('disabled');
                        document.getElementById('minify').disabled = true;
                        document.getElementById('minify').classList.add('disabled');
                    }

                    if (e?.target?.defaultValue && e.target.defaultValue !== e.target.value) {
                        // enable the save button
                        document.getElementById('save').disabled = false;
                        document.getElementById('save').classList.remove('disabled');
                        document.getElementById('save').classList.remove('secondary');
                        document.getElementById('save').classList.add('accent');
                    }
                    else {
                        document.getElementById('save').disabled = true;
                        document.getElementById('save').classList.add('disabled');
                        document.getElementById('save').classList.add('secondary');
                        document.getElementById('save').classList.remove('accent');
                    }
                },
                // onClick method
                onClick: (e) => {
                    console.log('üòÄ onClick', { target: e.target });
                    const viewModel = _sidebar.ViewModel;
                    const a1n = document.getElementById(viewModel.TEXT_CARD_ID).querySelector('.caption').innerText;
                    const target = e.target;
                    const editorCard = document.getElementById(viewModel.TEXT_CARD_ID);
                    if (target.id === 'prittfy') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.prittfy
                        });
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_sidebar.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.TextEditorHandler.onServerFailure)
                            .prettyPrintCell({ a1n, text });
                    }
                    else if (target.id === 'minify') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.minify
                        });
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_sidebar.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.TextEditorHandler.onServerFailure)
                            .minifyCell(a1n, text);
                    }
                    else if (target.id === 'highlight') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.highlight
                        });
                        google.script.run
                            .withSuccessHandler(_sidebar.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.TextEditorHandler.onServerFailure)
                            .highlightCell(a1n);
                    }
                    else if (target.id === 'save') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.save
                        });
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_sidebar.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.TextEditorHandler.onServerFailure)
                            .saveCell(a1n, text);
                    }
                    else if (target.id === 'close') {
                        // hide the text editor card
                        document.getElementById(viewModel.TEXT_CARD_ID).classList.add('hidden');
                    }
                    else if (target.id === 'openInDialog') {
                        // open the dialog
                        google.script.run
                            .withSuccessHandler(_sidebar.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_sidebar.TextEditorHandler.onServerFailure)
                            .openEditor(a1n);
                    }

                },
                onServerSuccess: (response) => {
                    console.log('üòÄ onServerSuccess', response);
                    const viewModel = _sidebar.ViewModel;
                    if (response) {
                        viewModel.renderTextEditor({
                            container: document.getElementById(viewModel.TEXT_CARD_ID),
                            a1nRange: response.a1n,
                            input: response.input,
                            message: response.message
                        });
                    }
                    viewModel.renderIdleState({
                        cardKey: viewModel.TEXT_CARD_ID,
                        message: resources.done
                    });

                    const editorCard = document.getElementById(viewModel.TEXT_CARD_ID);
                    _sidebar.TextEditorHandler.onKeyUp({
                        target: editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`)
                    });
                },
                onServerFailure: (response) => {
                    console.error('üòÄ onServerFailure', response);
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: viewModel.TEXT_CARD_ID,
                        message: `<span class="error">${response.message}</span>`
                    });
                    viewModel.renderLed({ led: 'üî¥' });
                    viewModel.enableAllButtons();
                }
            },
            // View class
            ViewModel: {
                WELCOME_CARD_ID: 'state-card',
                REPORT_CARD_ID: 'report-card',
                TEXT_CARD_ID: 'text-card',
                TEXT_AREA_ID: 'text-editor',
                SUMMARY_ID: 'summary',
                RANGE_ID: 'selectedRange',
                // start method
                start: () => {
                    console.log('üòÄ ViewModel.start');
                    _sidebar.ViewModel.renderSidebar({ container: document.getElementById("app") });
                },
                // renderSidebar method
                renderSidebar: ({ container = document.getElementById("app") }) => {
                    if (!container) {
                        return;
                    }

                    // Add container
                    container.innerHTML = '<div class="container" id="appContainer"></div>';
                    _sidebar.ViewModel.appendWelcomeCard({ container: container.querySelector('#appContainer') });
                    _sidebar.ViewModel.appendReportCard({ container: container.querySelector('#appContainer') });
                    _sidebar.ViewModel.appendTextEditorCard({ container: container.querySelector('#appContainer') });
                },
                // append State card
                appendWelcomeCard: ({ container }) => {
                    if (!container) {
                        return;
                    }

                    _sidebar.CardView.appendCard({
                        container: container,
                        key: _sidebar.ViewModel.WELCOME_CARD_ID,
                        title: resources.welcome,
                        subtitle: resources.bindSelectRangeDesc,
                        content: '<span id="selectedRange" class="range"></span>',
                        tip: resources.welcomeTips,
                        actions: [
                            {
                                id: 'rebind',
                                className: 'small secondary',
                                label: resources.rebind,
                                handler: 'Sidebar.AppHandler.onClick(event)'
                            }
                        ]
                    });
                },
                // append Report card
                appendReportCard: ({ container }) => {
                    if (!container) {
                        return;
                    }

                    _sidebar.CardView.appendCard({
                        container: container,
                        key: _sidebar.ViewModel.REPORT_CARD_ID,
                        title: resources.report,
                        subtitle: resources.bindSelectRange,
                        hidden: true,
                        content: '<div id="report" class="report"></div><div class="subtitle1" id="summary"></div>',
                        tip: resources.reportTips,
                        actions: [
                            {
                                id: 'refresh',
                                className: 'small secondary',
                                label: resources.refresh,
                                handler: 'Sidebar.ReportHandler.onClick(event)'
                            }
                        ]
                    });
                },
                // append text editor card
                appendTextEditorCard: ({ container }) => {
                    if (!container) {
                        return;
                    }

                    const actions = [
                        {
                            id: 'save', className: 'small secondary',
                            label: resources.save,
                            handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        },
                        {
                            id: 'prittfy', className: 'small primary',
                            label: resources.prittfy,
                            handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        },
                        {
                            id: 'minify',
                            className: 'small primary',
                            label: resources.minify,
                            handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        },
                        {
                            id: 'openInDialog',
                            className: 'small secondary',
                            label: resources.openInDialog,
                            handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        },
                        {
                            id: 'highlight',
                            className: 'small secondary',
                            label: resources.highlight,
                            handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        },
                        {
                            id: 'close',
                            className: 'small secondary',
                            label: resources.close, handler: 'Sidebar.TextEditorHandler.onClick(event)'
                        }
                    ];

                    const contet = ``;

                    _sidebar.CardView.appendCard({
                        container: container,
                        key: _sidebar.ViewModel.TEXT_CARD_ID,
                        title: resources.textEditor,
                        subtitle: 'üí´',
                        content: contet,
                        actions: actions,
                        hidden: true
                    });
                },
                // render textarea
                renderTextEditor: ({ container, a1nRange, input, message }) => {
                    const e = container.querySelector('.content');
                    if (!e) {
                        console.warn('ü§îüò∂‚Äçüå´Ô∏è e is null!!! ');
                        return;
                    }

                    let html = '';
                    html += `<div class="caption">${a1nRange}</div>`;
                    html += '<div>';
                    html += `<textarea class="textarea" id="${_sidebar.ViewModel.TEXT_AREA_ID}" name="text-editor" rows="10" cols="25" `
                        + `spellcheck="false" placeholder="${resources.textEditorPlaceholder}" onkeyup="Sidebar.TextEditorHandler.onKeyUp(event)">`;
                    html += input || '';
                    html += '</textarea>';

                    html += '</div>';
                    e.innerHTML = html;
                },
                // renderSelectedRange method
                renderSelectedRange: ({ container, range }) => {
                    if (!container) {
                        return;
                    }
                    container.innerHTML = '';
                    if (!range) {
                        container.innerHTML = resources.noValues;
                        return;
                    }
                    container.innerHTML = `<div>${range.a1n}</div>`;

                },
                // renderResponse method
                renderValidateResponse: ({ container, response }) => {
                    console.log('üòÄ renderResponse', { container, response });
                    if (!container) {
                        return;
                    }
                    if (!response) {
                        const summary = document.getElementById("summary");
                        summary.innerHTML = 'No values in the selected range';
                        return;
                    }

                    // render summary
                    if (response?.range) {
                        _sidebar.ViewModel.renderSummary({
                            container: document.getElementById("summary"),
                            response
                        });
                    }

                    // render report
                    if (response?.report) {
                        _sidebar.ViewModel.addTabelReportRows({
                            container: document.getElementById("report"),
                            response
                        });
                    }
                },
                // renderSummary method
                renderSummary: ({ container, response }) => {
                    if (!container) {
                        return;
                    }
                    container.innerHTML = '';
                    if (!response?.range) {
                        container.innerHTML = resources.noValues;
                        return;
                    }

                    const range = response.range;
                    const page = response.page;
                    const totalCells = (range.numRows) * (range.numColumns);

                    const totalSuccess = response.report.reduce((acc, row) => {
                        return acc + row.reduce((acc, col) => {
                            return acc + (col.isValid ? 1 : 0);
                        }, 0);
                    }, 0);

                    const totalFail = totalCells - totalSuccess;
                    let div = '';
                    div += '<div class="container center">';
                    div += `  <span class="label info" title="${resources.totalCells}">T:${totalCells}</span>`;
                    div += `  <span class="label success" title="${resources.totalSuccess}">S:${totalSuccess}</span>`;
                    div += `  <span class="label error" title="${resources.totalFail}">F:${totalFail}</span>`;
                    div += `  <span class="label info" title="${resources.a1nNotation}">${range.a1n}</span>`;
                    div += `  <span class="label info" title="${resources.numColumns}">C:${range.numColumns}</span>`;
                    div += `  <span class="label info" title="${resources.numRows}">R:${range.numRows}</span>`;
                    div += '</div>';
                    div += '<div class="container center">';
                    div += `  <span class="label info" title="${resources.pageSize}">P:${page.pageSize}</span>`;
                    div += `  <span class="label info" title="${resources.offset}">O:${page.offset}</span>`;
                    div += `  <span class="label info" title="${resources.nextOffset}">N:${response.nextOffset || ''}</span>`;
                    div += '</div>';

                    container.innerHTML = div;
                },
                // renderTabelReport method
                renderTabelReport: ({ container, range }) => {
                    if (!container) {
                        return;
                    }
                    container.innerHTML = '';
                    if (!range) {
                        container.innerHTML = resources.noValues;
                        return;
                    }

                    const rangeDiv = document.createElement('div');
                    rangeDiv.classList.add('caption');
                    rangeDiv.appendChild(document.createTextNode(range.a1n));
                    container.appendChild(rangeDiv);
                    const columns = range.columns || [];

                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const trh = document.createElement('tr');
                    trh.appendChild(document.createElement('th'));
                    columns.forEach((col) => {
                        const th = document.createElement('th');
                        th.appendChild(document.createTextNode(col));
                        trh.appendChild(th);
                    });
                    thead.appendChild(trh);
                    table.appendChild(thead);
                    const tbody = document.createElement('tbody');
                    table.appendChild(tbody);
                    container.appendChild(table);
                },
                // append rows to the table
                addTabelReportRows: ({ container, response }) => {
                    console.log('üòÄ addTabelReportRows', { container, response });
                    if (!container) {
                        return;
                    }
                    if (!response?.report) {
                        container.innerHTML = resources.noValues;
                        return;
                    }
                    const rows = response?.page?.rows || [];
                    const tbody = container.querySelector('tbody');
                    for (const [key1, row] of Object.entries(response.report)) {
                        const tr = document.createElement('tr');
                        const td1 = document.createElement('td');
                        td1.appendChild(document.createTextNode(rows[key1]));
                        tr.appendChild(td1);
                        for (const [key2, col] of Object.entries(row)) {
                            const td2 = document.createElement('td');
                            td2.appendChild(document.createTextNode(col.icon));
                            td2.classList.add('report-cell');
                            td2.title = col.message;
                            td2.id = col.a1n;
                            td2.classList.add(col.isValid ? 'valid' : 'invalid');
                            td2.addEventListener('click', (e) => {
                                _sidebar.TextEditorHandler.start({
                                    container: document.getElementById(_sidebar.ViewModel.TEXT_CARD_ID),
                                    cell: col
                                });
                            });
                            tr.appendChild(td2);
                        }
                        tbody.appendChild(tr);
                    }
                },
                // renderWorkInProgress method
                renderWorkInProgress: ({ cardKey, message }) => {
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: cardKey,
                        message: message
                    });
                    viewModel.renderLed({ led: 'üü°' });
                    viewModel.disableAllButtons();
                },
                // render idle state
                renderIdleState: ({ cardKey, message }) => {
                    const viewModel = _sidebar.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: cardKey,
                        message: message
                    });
                    viewModel.renderLed({ led: '' });
                    viewModel.enableAllButtons();
                },
                // renderSubtitle method
                renderSubtitle: ({ cardKey, message }) => {
                    const container = document.getElementById(cardKey);
                    if (!container) {
                        return;
                    }

                    const subtitle1 = container.querySelector('.subtitle1');
                    const subtitle2 = container.querySelector('.subtitle2');
                    if (!subtitle1 && !subtitle2) {
                        return;
                    }
                    if (subtitle2) {
                        subtitle2.innerHTML = message;
                    }
                    else {
                        subtitle1.innerHTML = message;
                    }
                },
                // render led
                renderLed: ({ led }) => {
                    const leds = document.getElementsByClassName("led");
                    if (!leds) {
                        leds.innerHTML = 'üîò';
                    }

                    for (let i = 0; i < leds.length; i++) {
                        leds[i].innerHTML = led;
                    }
                },
                // disableAllButtons method
                disableAllButtons: () => {
                    const buttons = document.querySelectorAll('input[type="button"]');

                    buttons.forEach((button) => {
                        button.disabled = true;
                        button.classList.add('disabled');
                    });

                    const textAreas = document.querySelectorAll('textarea');
                    textAreas.forEach((textArea) => {
                        textArea.disabled = true;
                    });
                },
                // enableAllButtons method
                enableAllButtons: () => {
                    const buttons = document.querySelectorAll('input[type="button"]');
                    buttons.forEach((button) => {
                        button.disabled = false;
                        button.classList.remove('disabled');
                    });

                    const textAreas = document.querySelectorAll('textarea');
                    textAreas.forEach((textArea) => {
                        textArea.disabled = false;
                    });
                }
            },
            // CardView class
            CardView: {
                appendCard: ({ container, key, title, subtitle, content, tip, actions, hidden }) => {
                    if (!container) {
                        return;
                    }

                    // check if the card already exists
                    const card = document.getElementById(key);
                    if (card) {
                        card.innerHTML = '';
                    }

                    let html = '';
                    // Card
                    html += `<div class="card ${hidden ? 'hidden' : ''}" id="${key}">`;
                    // Add card titlex
                    html += `  <div class="title">${title || '*'}`;
                    html += `    <div class="right led">*</div>`;
                    html += `    <div class="subtitle1">${subtitle || '*'}</div>`;
                    if (tip) {
                        html += `    <p class="tip">${tip || ''}</p>`;
                    }
                    html += '  </div>';
                    // Add card content
                    html += '  <div class="content body1">';
                    html += content || '';
                    html += '  </div>';

                    if (actions) {
                        // Add card actions
                        html += '  <div class="action">';
                        actions.forEach((action) => {
                            html += `    <input class="button ${action.className || 'primary'}" type="button" value="${action.label}"`
                                + ` id="${action.id}" `
                                + ` onclick="${action.handler}" />`;
                        });
                        // end of actions
                        html += '  </div>';
                    }
                    // end of card
                    html += '</div>';
                    container.innerHTML += html;
                }
            }
        };
        // Dialog editor
        const _editor = this.Editor = {
            // Model class
            AppHandler: {
                // start method
                start: (e) => {
                    console.log('üòÄ start', e);
                    const viewModel = _editor.ViewModel;
                    viewModel.renderDialog({ container: document.getElementById("app") });

                    viewModel.renderWorkInProgress({
                        ardKey: viewModel.WELCOME_CARD_ID,
                        message: resources.bindSelectRangeDesc
                    });
                    // call the server
                    google.script.run
                        .withSuccessHandler(_editor.AppHandler.onServerSuccess)
                        .withFailureHandler(_editor.AppHandler.onServerFailure)
                        .getCurrentCell();
                },
                // onClick method
                onClick: (e) => {
                    console.log('üòÄ onClick', e);
                    const viewModel = _editor.ViewModel;
                    if (e.target.id === 'refresh') {
                        // refresh the page
                    }
                },
                // onServerSuccess method
                onServerSuccess: (response) => {
                    console.log('üòÄ onServerSuccess', { response });
                    const viewModel = _editor.ViewModel;

                    viewModel.renderSubtitle({
                        cardKey: viewModel.WELCOME_CARD_ID,
                        message: resources.done
                    });
                    viewModel.renderLed({ led: 'üîò' });
                    viewModel.enableAllButtons();
                    // render the page with the response
                    viewModel.renderSelectedRange({
                        container: document.getElementById(viewModel.RANGE_ID),
                        range: response.cell
                    });
                    _editor.TextEditorHandler.start({
                        container: document.getElementById(viewModel.TEXT_CARD_ID),
                        cell: response.cell
                    });
                },
                // onServerFailure method
                onServerFailure: (response) => {
                    console.log('üòÄ onServerFailure', response);
                    const viewModel = _editor.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: viewModel.WELCOME_CARD_ID,
                        message: resources.error
                    });
                    // alert the error message
                    alert(response.message);
                    viewModel.renderLed({ led: 'üî¥' });
                    viewModel.enableAllButtons();
                }
            },
            TextEditorHandler: {
                // start method
                start: ({ container, cell }) => {
                    console.log('üòÄ TextEditorHandler.start', { container, cell });
                    // render the text editor using viewModel
                    const viewModel = _editor.ViewModel;
                    document.getElementById(viewModel.TEXT_CARD_ID).classList.remove('hidden')
                    viewModel.renderTextEditor({
                        container: container,
                        a1nRange: cell.a1n,
                        input: cell.input
                    });
                    _editor.TextEditorHandler.onKeyUp({
                        target: container.querySelector(`#${_editor.ViewModel.TEXT_AREA_ID}`)
                    });
                },
                // onKeyUp method
                onKeyUp: (e) => {
                    // validate the input
                    const text = e.target.value;
                    let isValid = true;
                    const viewModel = _editor.ViewModel;
                    try {
                        JSON.parse(text);
                        // clear the error message

                        viewModel.renderSubtitle({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: `<span class="success">‚úì<span> ${resources.jsonValid}`
                        });
                    } catch (error) {
                        isValid = false;
                        // show the error message
                        viewModel.renderSubtitle({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: `<span class="accent">‚®Ç ${error.message}</span>`
                        });
                    }
                },
                // onClick method
                onClick: (e) => {
                    const viewModel = _editor.ViewModel;
                    const a1n = document.getElementById(viewModel.TEXT_CARD_ID).querySelector('.caption').innerText;
                    const target = e.target;
                    const editorCard = document.getElementById(viewModel.TEXT_CARD_ID);
                    if (target.id === 'prittfy') {
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.prittfy
                        });
                        console.log('üòÄ prittfy', a1n);
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_editor.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_editor.TextEditorHandler.onServerFailure)
                            .prettyPrintCell({ a1n, text });
                    }
                    else if (target.id === 'minify') {
                        console.log('üòÄ minify', a1n);
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.minify
                        });
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_editor.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_editor.TextEditorHandler.onServerFailure)
                            .minifyCell(a1n, text);
                    }
                    else if (target.id === 'highlight') {
                        console.log('üòÄ highlight', a1n);
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.highlight
                        });
                        google.script.run
                            .withSuccessHandler(_editor.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_editor.TextEditorHandler.onServerFailure)
                            .highlightCell(a1n);
                    }
                    else if (target.id === 'save') {
                        console.log('üòÄ save');
                        viewModel.renderWorkInProgress({
                            cardKey: viewModel.TEXT_CARD_ID,
                            message: resources.save
                        });
                        const text = editorCard.querySelector(`#${viewModel.TEXT_AREA_ID}`).value;
                        google.script.run
                            .withSuccessHandler(_editor.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_editor.TextEditorHandler.onServerFailure)
                            .saveCell(a1n, text);
                    }
                    else if (target.id === 'close') {
                        console.log('üòÄ close');
                        // hide the text editor card
                        document.getElementById(viewModel.TEXT_CARD_ID).classList.add('hidden');
                    }
                    else if (target.id === 'openInDialog') {
                        console.log('üòÄ openInDialog');
                        // open the dialog
                        google.script.run
                            .withSuccessHandler(_editor.TextEditorHandler.onServerSuccess)
                            .withFailureHandler(_editor.TextEditorHandler.onServerFailure)
                            .openEditorFromSidebar(a1n);
                    }

                },
                onServerSuccess: (response) => {
                    console.log('üòÄ onServerSuccess', response);
                    const viewModel = _editor.ViewModel;
                    if (response) {
                        viewModel.renderTextEditor({
                            container: document.getElementById(viewModel.TEXT_CARD_ID),
                            a1nRange: response.a1n,
                            input: response.input,
                            message: response.message
                        });
                    }
                    viewModel.renderSubtitle({
                        cardKey: viewModel.TEXT_CARD_ID,
                        message: resources.done
                    });
                    viewModel.renderLed({ led: 'üîò' });
                    viewModel.enableAllButtons();
                },
                onServerFailure: (response) => {
                    console.error('üòÄ onServerFailure', response);
                    const viewModel = _editor.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: viewModel.TEXT_CARD_ID,
                        message: resources.error
                    });
                    viewModel.renderLed({ led: 'üî¥' });
                    viewModel.enableAllButtons();
                }
            },
            // View class
            ViewModel: {
                WELCOME_CARD_ID: 'state-card',
                TEXT_CARD_ID: 'text-card',
                TEXT_AREA_ID: 'text-editor',
                RANGE_ID: 'selectedRange',
                // start method
                start: () => {
                    console.log('üòÄ ViewModel.start');
                    _editor.ViewModel.renderDialog({ container: document.getElementById("app") });
                },
                // renderSidebar method
                renderDialog: ({ container = document.getElementById("app") }) => {
                    console.log('üòÄ renderDialog', { container });
                    if (!container) {
                        return;
                    }

                    // Add container
                    container.innerHTML = '<div class="container" id="appContainer"></div>';
                    _editor.ViewModel.renderWelcomeCard({ container: container.querySelector('#appContainer') });
                    _editor.ViewModel.renderTextEditorCard({ container: container.querySelector('#appContainer') });
                },
                // append State card
                renderWelcomeCard: ({ container }) => {
                    console.log('üòÄ renderWelcomeCard', { container });
                    if (!container) {
                        return;
                    }

                    _editor.CardView.appendCard({
                        container: container,
                        key: _editor.ViewModel.WELCOME_CARD_ID,
                        title: resources.welcome,
                        subtitle: resources.bindSelectRangeDesc,
                        content: '<span id="selectedRange" class="range"></span>'
                    });
                },
                // append text editor card
                renderTextEditorCard: ({ container }) => {
                    console.log('üòÄ renderTextEditorCard', { container });
                    if (!container) {
                        return;
                    }

                    const actions = [
                        { id: 'prittfy', label: resources.prittfy, handler: 'Editor.TextEditorHandler.onClick(event)' },
                        { id: 'minify', label: resources.minify, handler: 'Editor.TextEditorHandler.onClick(event)' },
                        { id: 'save', label: resources.save, handler: 'Editor.TextEditorHandler.onClick(event)' }
                    ];

                    const contet = ``;

                    _editor.CardView.appendCard({
                        container: container,
                        key: _editor.ViewModel.TEXT_CARD_ID,
                        title: resources.textEditor,
                        subtitle: 'üí´',
                        content: contet,
                        actions: actions,
                        hidden: true
                    });
                },
                // render textarea
                renderTextEditor: ({ container, a1nRange, input, message }) => {
                    console.log("renderTextEditor", { container, a1nRange, input, message });
                    const e = container.querySelector('.content');
                    if (!e) {
                        console.warn('ü§îüò∂‚Äçüå´Ô∏è e is null!!! ');
                        return;
                    }

                    let html = '';
                    html += `<div class="caption">${a1nRange}</div>`;
                    html += '<div>';
                    html += `<textarea class="textarea" id="${_editor.ViewModel.TEXT_AREA_ID}" name="text-editor" rows="10" cols="25" `
                        + `spellcheck="false" placeholder="Enter your text here..." onkeyup="Editor.TextEditorHandler.onKeyUp(event)">`;
                    html += input || '';
                    html += '</textarea>';

                    html += '</div>';
                    e.innerHTML = html;
                },
                // renderSelectedRange method
                renderSelectedRange: ({ container, range }) => {
                    console.log('üòÄ renderSelectedRange', { container, range });
                    if (!container) {
                        return;
                    }
                    container.innerHTML = '';
                    if (!range) {
                        container.innerHTML = resources.noValues;
                        return;
                    }
                    container.innerHTML = range.a1n;

                },
                // renderWorkInProgress method
                renderWorkInProgress: ({ cardKey, message }) => {
                    console.log('üòÄ renderWorkInProgress');
                    const viewModel = _editor.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: cardKey,
                        message: message
                    });
                    viewModel.renderLed({ led: 'üü°' });
                    viewModel.disableAllButtons();
                },
                // render idle state
                renderIdleState: ({ cardKey, message }) => {
                    console.log('üòÄ renderIdleState');
                    const viewModel = _editor.ViewModel;
                    viewModel.renderSubtitle({
                        cardKey: cardKey,
                        message: message
                    });
                    viewModel.renderLed({ led: '' });
                    viewModel.enableAllButtons();
                },
                // renderSubtitle method
                renderSubtitle: ({ cardKey, message }) => {
                    console.log('üòÄ renderSubtitle', message);
                    const container = document.getElementById(cardKey);
                    if (!container) {
                        return;
                    }

                    const subtitle1 = container.querySelector('.subtitle1');
                    const subtitle2 = container.querySelector('.subtitle2');
                    if (!subtitle1 && !subtitle2) {
                        return;
                    }
                    if (subtitle2) {
                        subtitle2.innerHTML = message;
                    }
                    else {
                        subtitle1.innerHTML = message;
                    }
                },
                // render led
                renderLed: ({ led }) => {
                    console.log('üòÄ renderLed', led);
                    const leds = document.getElementsByClassName("led");
                    if (!leds) {
                        leds.innerHTML = 'üîò';
                    }

                    for (let i = 0; i < leds.length; i++) {
                        leds[i].innerHTML = led;
                    }
                },
                // disableAllButtons method
                disableAllButtons: () => {
                    const buttons = document.querySelectorAll('input[type="button"]');
                    console.log('üòÄ disableAllButtons', buttons);
                    buttons.forEach((button) => {
                        button.disabled = true;
                        button.classList.add('disabled');
                    });

                    const textAreas = document.querySelectorAll('textarea');
                    textAreas.forEach((textArea) => {
                        textArea.disabled = true;
                    });
                },
                // enableAllButtons method
                enableAllButtons: () => {
                    console.log('üòÄ enableAllButtons');
                    const buttons = document.querySelectorAll('input[type="button"]');
                    buttons.forEach((button) => {
                        button.disabled = false;
                        button.classList.remove('disabled');
                    });

                    const textAreas = document.querySelectorAll('textarea');
                    textAreas.forEach((textArea) => {
                        textArea.disabled = false;
                    });
                }
            },
            // CardView class
            CardView: {
                appendCard: ({ container, key, title, subtitle, content, actions, hidden }) => {
                    console.log('üòÄ renderCard', { container, key, title, subtitle, content, actions });
                    if (!container) {
                        return;
                    }

                    // check if the card already exists
                    const card = document.getElementById(key);
                    if (card) {
                        card.innerHTML = '';
                    }

                    let html = '';
                    // Card
                    html += `<div class="card ${hidden ? 'hidden' : ''}" id="${key}">`;
                    // Add card titlex
                    html += `  <div class="title">${title}`;
                    html += '    <div class="right led"></div>';
                    if (subtitle) {
                        html += `    <div class="subtitle1">${subtitle}</div>`;
                    }
                    html += '  </div>';
                    // Add card content
                    html += '  <div class="content body1">';
                    html += content || '';
                    html += '  </div>';
                    if (actions) {
                        // Add card actions
                        html += '  <div class="action">';
                        actions.forEach((action) => {
                            html += `    <input class="button ${action.className || 'primary'}" type="button" value="${action.label}"`
                                + ` id="${action.id}" `
                                + ` onclick="${action.handler}" />`;
                        });
                        html += '  </div>';
                    }

                    // end of card
                    html += '</div>';
                    container.innerHTML += html;
                }
            }
        };
    })();
</script>