<!-- JavaScript -->
<script>
    // namespace SidebarValidator
    var AddOns = AddOns || {};
    AddOns.ViewModel = AddOns.ViewModel || {};
    // ViewModel class
    AddOns.ViewModel = function () {
        this.renderSidebar = ({
            container = document.getElementById("app")
        }) => {
            console.log('üòÄ renderSidebar', { container });
            if (!container) {
                return;
            }
            let html = '';

            html += '<h1>JSON Editor for Google Sheets‚Ñ¢Ô∏è</h1>';
            html += '<p>JSON Editor for Google Sheets‚Ñ¢Ô∏è is a Google Sheets Add-on that allows you to edit JSON data in a spreadsheet.</p>';
            html += '<div id="primary-action" class="primary-action"></div>';
            // render the response container
            html += '<div id="response" class="response">';
            html += '   <div id="summary" class="summary"></div>';
            html += '   <div id="report" class="report"></div>';
            html += '   <div id="text-editor" class="text-editor"></div>';
            html += '</div>';
            container.innerHTML = html;
            this.renderToolbar({ container: document.getElementById("primary-action") });
        };

        this.renderValidationResponse = ({ container, response }) => {
            console.log('üòÄ renderValidationResponse', { container, response });
            if (!container) {
                return;
            }

            if (!response) {
                const summary = document.getElementById("summary");
                summary.innerHTML = 'No values in the selected range';
                return;
            }

            if (response?.range) {
                this.renderSummary({
                    container: container.querySelector('#summary'),
                    response
                });
            }

            if (response?.report) {
                this.renderTabelReport({
                    container: container.querySelector('#report'),
                    response
                });
            }
        };

        this.renderSummary = ({ container, response }) => {
            console.log('üòÄ renderSummary', { container, response });
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!response?.range) {
                container.innerHTML = 'No values in the selected range';
                return;
            }
            const range = response.range;
            const totalCells = (range.numRows || 1) * (range.numColumns || 1);
            const totalSuccess = response.report.reduce((acc, row) => {
                return acc + row.reduce((acc, col) => {
                    return acc + (col.icon === '‚úÖ' ? 1 : 0);
                }, 0);
            }, 0);

            const totalFail = totalCells - totalSuccess;
            container.innerHTML += `<span class="info">Sum. ${totalCells}</span>`;
            container.innerHTML += ` (<span class="success">${totalSuccess}</span>`;
            container.innerHTML += `/<span class="error">${totalFail}</span>)`;
            container.innerHTML += `<div class="caption">${range.a1n}</div>`;
        };

        this.renderTabelReport = ({ container, response }) => {
            console.log('üòÄ renderTabelReport', { container, response });
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!response?.report) {
                container.innerHTML = 'No values in the selected range';
                return;
            }

            // build columns array (like: ['C','D','E']) from the response range like 'C1:E3'
            const columns = [''];
            const range = response.range;
            const start = range.a1n.split(':').shift();
            const end = range.a1n.split(':').pop();
            const startCol = start.match(/[A-Z]+/g).shift();
            const endCol = end.match(/[A-Z]+/g).pop();
            const startRow = start.match(/\d+/g).shift();
            const endRow = end.match(/\d+/g).pop();
            for (let i = startCol.charCodeAt(0); i <= endCol.charCodeAt(0); i++) {
                columns.push(String.fromCharCode(i));
            }
            // build list of rows from the response report range
            const rows = [];
            for (let i = startRow; i <= endRow; i++) {
                rows.push(i);
            }

            const table = document.createElement('table');
            table.style.width = '100%';
            table.setAttribute('border', '1');
            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            columns.forEach((col) => {
                const th = document.createElement('th');
                th.appendChild(document.createTextNode(col));
                trh.appendChild(th);
            });
            thead.appendChild(trh);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            for (const [key1, row] of Object.entries(response.report)) {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.appendChild(document.createTextNode(rows[key1]));
                tr.appendChild(td1);
                // loop through the columns
                for (const [key2, col] of Object.entries(row)) {
                    const td2 = document.createElement('td');
                    td2.appendChild(document.createTextNode(col.icon));
                    // set class for the text node
                    td2.classList.add('report-cell');
                    // set tooltip for the td2
                    td2.title = col.message;
                    // set click event for the td2
                    td2.addEventListener('click', (e) => {
                        console.log('üòÄ report-cell click', e);
                        // focus the sheet cellfrom col.range
                        //google.script.run.focusCell(col.range);
                        // render the text editor
                        TextEditorHandler.start({
                            e: document.getElementById("text-editor"),
                            cell: col
                        });
                    });
                    tr.appendChild(td2);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            container.appendChild(table);
        };

        this.renderToolbar = ({ container }) => {
            console.log('üòÄ renderToolbar', container);
            if (!container) {
                return;
            }
            let html = '';
            // render validate button
            html += '<input class="button primary" type="button" id="validate" value="Validate" '
                + 'onclick="AppHandler.handleValidateEvent(event)" />';

            // render minify alls button
            html += '<input class="button primary" type="button" id="minifyAll" value="Minify All" '
                + 'onclick="AppHandler.handleMinifyAllEvent(event)" />';
            // render prittfy all button
            html += '<input class="button primary" type="button" id="prittfyAll" value="Prittfy All" '
                + 'onclick="AppHandler.handlePrettyPrintAllEvent(event)" />';
            container.innerHTML = html;

        };

        this.renderTextEditor = ({ container, a1nRange, input, message }) => {
            console.log('üòÄ renderTextEditor', { container, a1nRange, input });
            if (!container) {
                return;
            }

            let html = '';
            html += `<div class="caption">${a1nRange}</div>`;
            html += `<textarea id="textArea" name="textArea" rows="20" cols="30" `
                + `onkeyup="TextEditorHandler.onKeyUp(event)" `
                + `>${input || ''}</textarea>`;
            html += `<div class="feedback">${message}</div>`
            html += '<div class="toolbar">';
            // render prittfy button
            html += '<input class="button primary" type="button" id="prittfy" value="Prittfy" '
                + `onclick="TextEditorHandler.onClick(event, '${a1nRange}')" />`;
            // render minify button
            html += '<input class="button primary" type="button" id="minify" value="Minify" '
                + `onclick="TextEditorHandler.onClick(event, '${a1nRange}')" />`;
            //render highlight button
            html += '<input class="button info" type="button" id="highlight" value="Highlight" '
                + `onclick="TextEditorHandler.onClick(event, '${a1nRange}')" />`;
            // render cancel button
            html += '<input class="button accent" type="button" id="cancel" value="Cancel" '
                + `onclick="TextEditorHandler.onClick(event, '${a1nRange}')" />`;
            // render save button
            html += '<input class="button accent" type="button" id="save" value="Save" '
                + `onclick="TextEditorHandler.onClick(event, '${a1nRange}')" />`;
            html += '</div>';
            container.innerHTML = html;
        };

        this.renderLoading = (element) => {
            console.log('üòÄ renderLoading', element);
            element.innerHTML = '<div class="loading" id="loading">Loading... please wait</div>';
        };
    };
    // event handler
    const AppHandler = {
        start: (e) => {
            console.log('üòÄ start', e);
            const viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ container: document.getElementById("app") });
        },
        handleValidateEvent: (e) => {
            console.log('üòÄ handleValidateEvent', e);
            let viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ container: document.getElementById("app") });
            const onServerSuccess = (response) => {
                console.log('üòÄ onServerSuccess', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            const onServerFailure = (response) => {
                console.log('üòÄ onServerFailure', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            // call the server
            google.script.run
                .withSuccessHandler(onServerSuccess)
                .withFailureHandler(onServerFailure)
                .doValidationReport();
        },
        handleMinifyAllEvent: (e) => {
            console.log('üòÄ handleMinifyAllEvent', e);
            let viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ container: document.getElementById("app") });
            const onServerSuccess = (response) => {
                console.log('üòÄ onServerSuccess', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            const onServerFailure = (response) => {
                console.log('üòÄ onServerFailure', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            // call the server
            google.script.run
                .withSuccessHandler(onServerSuccess)
                .withFailureHandler(onServerFailure)
                .minifyAllJsonOnServer();
        },

        handlePrettyPrintAllEvent: (e) => {
            console.log('üòÄ handlePrettyPrintAllEvent', e);
            let viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ container: document.getElementById("app") });
            const onServerSuccess = (response) => {
                console.log('üòÄ onServerSuccess', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            const onServerFailure = (response) => {
                console.log('üòÄ onServerFailure', response);
                // render the page with the response
                viewModel.renderValidationResponse({
                    container: document.getElementById("response"),
                    response
                });
            };

            // call the server
            google.script.run
                .withSuccessHandler(onServerSuccess)
                .withFailureHandler(onServerFailure)
                .prettyPrintAllJsonOnServer();
        }
    };

    const TextEditorHandler = {
        start: ({ e, cell }) => {
            console.log('üòÄ TextEditorHandler.start', { e, cell });
            // render the text editor using viewModel
            const viewModel = new AddOns.ViewModel();
            viewModel.renderTextEditor({
                container: e,
                a1nRange: cell.range,
                input: cell.input,
                message: cell.message
            });
        },
        onKeyUp: (e) => {
            console.log('üòÄ TextEditorHandler.onKeyUp', e);
            // validate the input
            const text = e.target.value;
            let isValid = true;
            try {
                JSON.parse(text);
                e.target.nextElementSibling.innerHTML = '';
            } catch (error) {
                isValid = false;
                // show the error message
                e.target.nextElementSibling.innerHTML = error.message;
            }
            if (isValid) {
                e.target.classList.remove('error');
            } else {
                e.target.classList.add('error');
            }

        },
        onClick: (e, a1n) => {
            console.log('üòÄ TextEditorHandler.onClick', { e, a1n });
            const viewModel = new AddOns.ViewModel();
            const target = e.target;
            if (target.id === 'prittfy') {
                console.log('üòÄ prittfy', a1n);
                const text = document.getElementById('textArea').value;
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('üòÄ prettyPrintCell', response);
                        viewModel.renderTextEditor({
                            container: document.getElementById("text-editor"),
                            a1nRange: a1n,
                            input: response.input,
                            message: response.message
                        });
                    })
                    .withFailureHandler((response) => {
                        console.log('üòÄ prettyPrintCell', response);
                    })
                    .prettyPrintCell(a1n, text);
            } else if (target.id === 'minify') {
                console.log('üòÄ minify', a1n);
                const text = document.getElementById('textArea').value;
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('üòÄ minifyCell', response);
                        viewModel.renderTextEditor({
                            container: document.getElementById("text-editor"),
                            a1nRange: a1n,
                            input: text,
                            message: response.message
                        });
                    })
                    .withFailureHandler((response) => {
                        console.log('üòÄ minifyCell', response);
                    })
                    .minifyCell(a1n, text);
            } else if (target.id === 'highlight') {
                console.log('üòÄ highlight', a1n);
                google.script.run.highlightCell(a1n);
            } else if (target.id === 'cancel') {
                console.log('üòÄ cancel');

            } else if (target.id === 'save') {
                console.log('üòÄ save');
                const text = document.getElementById('textArea').value;
                google.script.run
                    .withSuccessHandler((response) => {
                        console.log('üòÄ saveCell', response);
                    })
                    .withFailureHandler((response) => {
                        console.log('üòÄ saveCell', response);
                    })
                    .saveCell(a1n, text);
            }
        }
    }

    window.addEventListener('load', function () {
        console.log('Page is loaded');
        AppHandler.start();
    });
</script>