<!-- JavaScript -->
<script>
    // namespace SidebarValidator
    var AddOns = AddOns || {};
    AddOns.ViewModel = AddOns.ViewModel || {};
    // ViewModel class
    AddOns.ViewModel = function () {
        this.renderSidebar = ({
            container = document.getElementById("app"),
            loading = false,
            response
        }) => {
            console.log('ğŸ˜€ renderSidebar', { container, loading, response });
            if (!container) {
                return;
            }
            container.innerHTML = '';
            container.innerHTML += '<h1>JSON Editor for Google Sheetsâ„¢ï¸</h1>';
            container.innerHTML += '<p>JSON Editor for Google Sheetsâ„¢ï¸ is a Google Sheets Add-on that allows you to edit JSON data in a spreadsheet.</p>';
            container.innerHTML += '<div id="toolbar" class="toolbar"></div>';
            this.renderToolbar({ container: document.getElementById("toolbar"), loading, response });
            container.innerHTML += `<div id="message" class="message" >${loading ? 'Loading... please wait' : 'ğŸ˜€'}</div>`;
            container.innerHTML += '<div id="summary" class="summary"></div>';
            container.innerHTML += '<div id="report" class="report"></div>';

            if (response?.range) {
                this.renderSummary({
                    container: document.getElementById("summary"),
                    loading,
                    response
                });
            }

            if (response?.report) {
                this.renderTabelReport({
                    container: document.getElementById("report"),
                    loading,
                    response
                });
            }
        };

        this.renderSummary = ({ container, loading, response }) => {
            console.log('ğŸ˜€ renderSummary', { container, loading, response });
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!response?.range) {
                container.innerHTML = 'No values in the selected range';
                return;
            }
            const range = response.range;
            const totalCells = (range.numRows || 1) * (range.numColumns || 1);
            const totalSuccess = response.report.reduce((acc, row) => {
                return acc + row.reduce((acc, col) => {
                    return acc + (col.icon === 'âœ…' ? 1 : 0);
                }, 0);
            }, 0);

            const totalFail = totalCells - totalSuccess;
            container.innerHTML += `<span>${range.a1n}</span>`;
            container.innerHTML += `<span>total: ${totalCells}</span>`;
            if (totalFail > 0) {
                container.innerHTML += `<span class="warn">${totalFail}</span>`;
            }
            if (totalSuccess > 0) {
                container.innerHTML += `<span class="success">${totalSuccess}</span>`;
            }
        };

        this.renderTabelReport = ({ container, loading, response }) => {
            console.log('ğŸ˜€ renderTabelReport', { container, loading, response });
            if (!container) {
                return;
            }
            container.innerHTML = '';
            if (!response?.report) {
                container.innerHTML = 'No values in the selected range';
                return;
            }

            // build columns array (like: ['C','D','E']) from the response range like 'C1:E3'
            const columns = [''];
            const range = response.range;
            const start = range.a1n.split(':').shift();
            const end = range.a1n.split(':').pop();
            const startCol = start.match(/[A-Z]+/g).shift();
            const endCol = end.match(/[A-Z]+/g).pop();
            const startRow = start.match(/\d+/g).shift();
            const endRow = end.match(/\d+/g).pop();
            for (let i = startCol.charCodeAt(0); i <= endCol.charCodeAt(0); i++) {
                columns.push(String.fromCharCode(i));
            }
            // build list of rows from the response report range
            const rows = [];
            for (let i = startRow; i <= endRow; i++) {
                rows.push(i);
            }

            const table = document.createElement('table');
            table.style.width = '100%';
            table.setAttribute('border', '1');
            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            columns.forEach((col) => {
                const th = document.createElement('th');
                th.appendChild(document.createTextNode(col));
                trh.appendChild(th);
            });
            thead.appendChild(trh);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            for (const [key1, row] of Object.entries(response.report)) {
                const tr = document.createElement('tr');
                const td1 = document.createElement('td');
                td1.appendChild(document.createTextNode(rows[key1]));
                tr.appendChild(td1);
                // loop through the columns
                for (const [key2, col] of Object.entries(row)) {
                    const td2 = document.createElement('td');
                    td2.appendChild(document.createTextNode(col.icon));
                    // set class for the text node
                    td2.classList.add('report-cell');
                    // set tooltip for the td2
                    td2.title = col.message;
                    // set click event for the td2
                    td2.addEventListener('click', (e) => {
                        console.log('ğŸ˜€ report-cell click', e);
                        // focus the sheet cellfrom col.range
                        google.script.run.focusCell(col.range);
                    });
                    tr.appendChild(td2);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            container.appendChild(table);
        };

        this.renderToolbar = ({ container, loading, response }) => {
            console.log('ğŸ˜€ renderToolbar', container);
            container.innerHTML = '';
            // Validate button
            container.innerHTML += '<input class="button" type="button" id="validate" value="Validate"'
                + ' onclick="AppHandler.onToolbarClick(event)" />';

            // Checkboxes
            container.innerHTML += '<div class="checkboxes">';
            container.innerHTML += '<input type="checkbox" id="check1" name="check1" value="check1">';
            container.innerHTML += '<label for="check1">Check 1</label>';
            container.innerHTML += '<input type="checkbox" id="check2" name="check2" value="check2">';
            container.innerHTML += '<label for="check2">Check 2</label>';
            container.innerHTML += '</div>';
        };

        this.renderLoading = (element) => {
            console.log('ğŸ˜€ renderLoading', element);
            element.innerHTML = '<div class="loading" id="loading">Loading... please wait</div>';
        };
    };
    // event handler
    const AppHandler = {
        start: (e) => {
            console.log('ğŸ˜€ start', e);
            const viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ loading: false });
        },
        onToolbarClick: (e) => {
            console.log('ğŸ˜€ onClick', e);
            switch (e.target.id) {
                case 'validate':
                    AppHandler.handleValidateEvent(e);
                    break;
                case 'close':
                    google.script.host.close();
                    break;
                default:
                    break;
            }

        },
        handleValidateEvent: (e) => {
            console.log('ğŸ˜€ handleValidateEvent', e);
            let viewModel = new AddOns.ViewModel();
            viewModel.renderSidebar({ loading: true });
            const onServerSuccess = (response) => {
                console.log('ğŸ˜€ onServerSuccess', response);
                // render the page with the response
                viewModel.renderSidebar({ loading: false, response });
            };

            const onServerFailure = (response) => {
                console.log('ğŸ˜€ onServerFailure', response);
                // render the page with the response
                viewModel.renderSidebar({ loading: false, response });
            };

            // call the server
            google.script.run
                .withSuccessHandler(onServerSuccess)
                .withFailureHandler(onServerFailure)
                .validateJsonOnServerSummaryReport();
        }
    };


    window.addEventListener('load', function () {
        console.log('Page is loaded');
        AppHandler.start();
    });
</script>